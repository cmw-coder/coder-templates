#!/bin/bash

# é¢œè‰²æ”¯æŒæ£€æµ‹
if [ -n "$CODER" ] || [ -t 1 ]; then
    COLOR_GREEN=$(echo -e "\033[32m")
    COLOR_CYAN=$(echo -e "\033[36m")
    COLOR_RED=$(echo -e "\033[31m")
    COLOR_RESET=$(echo -e "\033[0m")
else
    COLOR_GREEN="" && COLOR_CYAN="" && COLOR_RED="" && COLOR_RESET=""
fi

# å‚æ•°æ£€æŸ¥
if [ $# -ne 5 ]; then
    echo "- â” Usage: svn-co <url> <folder-list> <path> <username> <password>"
    exit 1
fi

# å…¥å‚å¤„ç†
PARAM_BASE_SVN_URL="$1"
# shellcheck disable=SC2001
PARAM_FOLDER_LIST=$(echo "${2//[\[\]]/}" | sed 's/,/ /g')
PARAM_LOCAL_DIR="$3"
PARAM_SVN_USERNAME="$4"
PARAM_SVN_PASSWORD="$5"

function svn_with_auth() {
    svn "$@" --non-interactive --username "$PARAM_SVN_USERNAME" --password "$PARAM_SVN_PASSWORD"
}
function format_duration() {
    local seconds=$1
    local hours=$((seconds / 3600))
    local minutes=$(((seconds % 3600) / 60))
    local seconds=$((seconds % 60))
    printf "%02d:%02d:%02d" $hours $minutes $seconds
}
function get_filename_max_length() {
    local term_length=$1
    local bar_length=$2
    local filename_max_length=$((term_length - (bar_length + 16)))               # ä¿ç•™16å­—ç¬¦ç»™å…¶ä»–å…ƒç´ 
    filename_max_length=$((filename_max_length > 10 ? filename_max_length : 10)) # æœ€å°æ˜¾ç¤º10å­—ç¬¦
    filename_max_length=$((filename_max_length - 3))                             # ç•™3å­—ç¬¦ç»™çœç•¥å·
    echo $filename_max_length
}
function get_entry_count_in_svn_url() {
    local url="$1"
    local entry_count
    for retry in {1..3}; do
        entry_count=$(svn_with_auth list -R "$url" 2>/dev/null | wc -l)
        [ "$entry_count" -gt 0 ] && break
        echo -e "${COLOR_RED}- â— Retry $retry/3 getting file count...${COLOR_RESET}" >&2
        sleep 1
    done
    echo "$entry_count"
}
function get_progress_bar_character() {
    if echo "â–ˆ" | grep -q "â–ˆ"; then
        echo "â–ˆ"
    else
        echo "#"
    fi
}
function get_progress_bar_length() {
    local bar_length=$(($1 - 50))
    bar_length=$((bar_length > 20 ? bar_length : 20)) # æœ€å°20å­—ç¬¦
    bar_length=$((bar_length < 60 ? bar_length : 60)) # æœ€å¤§60å­—ç¬¦
    echo $bar_length
}
function update_with_progress() {
    local update_path="$1"
    local entry_count="$2"
    local indentation="$3"

    local index=0
    local last_update_time=0
    local spinner_frames=("â ‹" "â ™" "â ¹" "â ¸" "â ¼" "â ´" "â ¦" "â §" "â ‡" "â ")

    local bar_content
    local bar_length
    local base_path
    local current_time
    local display_filename
    local elapsed_seconds
    local escaped_base_path
    local escaped_local_dir
    local filename_max_length
    local filename_truncated_front_length
    local filename_truncated_back_length
    local filled
    local formatted_elapsed_time
    local percentage
    local progress_bar_char
    local raw_filename
    local start_time
    local term_length
    local update_interval

    # å˜é‡åˆå§‹åŒ–
    term_length=$(($(tput cols 2>/dev/null || echo 80) - ${#indentation}))
    bar_length=$(get_progress_bar_length "$term_length")
    filename_max_length=$(get_filename_max_length "$term_length" "$bar_length")
    filename_truncated_front_length=$((filename_max_length / 2))
    filename_truncated_back_length=$((filename_max_length - filename_truncated_front_length))

    base_path=$(echo "$PARAM_BASE_SVN_URL" | sed -E '
        s#^[^/]+://[^/]+##;    # ç§»é™¤åè®®å’ŒåŸŸå
        s#/$##;                # ç§»é™¤ç»“å°¾æ–œæ 
        s#^/?##                # ç§»é™¤å¯èƒ½æ®‹ç•™çš„èµ·å§‹æ–œæ 
    ')
    escaped_base_path=$(echo "$base_path" | sed 's/[\/&]/\\&/g')
    escaped_local_dir=$(basename "$PARAM_LOCAL_DIR" | sed 's/[\/&]/\\&/g')

    progress_bar_char=$(get_progress_bar_character)
    start_time=$(date +%s)
    update_interval=$((entry_count / 800))
    update_interval=$((update_interval > 5 ? update_interval : 5))

    # å‘½ä»¤è¿›åº¦å¾ªç¯
    while read -r line; do
        # è§£æåŸå§‹æ–‡ä»¶å
        raw_filename=$(echo "$line" | sed -E 's/^[A-Z] +//')

        # å¤šçº§è·¯å¾„æˆªæ–­å¤„ç†
        display_filename=$(echo "$raw_filename" | sed -E "
            s#^${escaped_local_dir}/?##;
            s#^${escaped_base_path}/?##;
            s#^/?##;
            s/^(.{$filename_truncated_front_length}).*(.{$filename_truncated_back_length})$/\1...\2/;
            t;
            s/^(.{${filename_max_length}}).+/\1.../;
        ")

        # è¿›åº¦è®¡ç®—
        if echo "$line" | grep -q "A    "; then
            ((index++))
        fi
        percentage=$(awk "BEGIN {printf \"%.2f\", $index*100/$entry_count}")

        # Coderç¯å¢ƒä¸‹æŒ‰æ—¶é—´é—´éš”è¾“å‡º
        if [ -n "$CODER" ]; then
            current_time=$(date +%s)
            if ((current_time - last_update_time >= update_interval)); then
                elapsed_seconds=$((current_time - start_time))
                formatted_elapsed_time=$(format_duration $elapsed_seconds)
                echo -e "\r${indentation}|-- Progress: ${COLOR_CYAN}${percentage}%${COLOR_RESET} | Time: ${formatted_elapsed_time} | Files: ${index}/${entry_count}" >/dev/tty
                last_update_time=$current_time
            fi
        else
            # æ„å»ºè¿›åº¦æ¡
            filled=$((bar_length * index / entry_count))
            filled=$((filled > bar_length ? bar_length : filled))
            bar_content=$(eval printf "%0.s${progress_bar_char}" "{1..$filled}")

            # åŠ¨æ€è¾“å‡ºæ ¼å¼
            printf "\r%s%s [%s%s%s] %6s%% %s%s%s\033[K" \
                "${indentation}" \
                "${spinner_frames[index % ${#spinner_frames[@]}]}" \
                "$COLOR_GREEN" \
                "$bar_content" \
                "$COLOR_RESET" \
                "$percentage" \
                "$COLOR_CYAN" \
                "$display_filename" \
                "$COLOR_RESET"
        fi
    done < <(svn_with_auth up --set-depth infinity "$update_path" 2>&1)

    # å¤„ç†æœ€åä¸€æ¬¡è¾“å‡º
    index=$((index > 0 ? index - 1 : 0))
    percentage=$(awk "BEGIN {printf \"%.2f\", $index*100/$entry_count}")
    if [ -n "$CODER" ]; then
        current_time=$(date +%s)
        elapsed_seconds=$((current_time - start_time))
        formatted_elapsed_time=$(format_duration $elapsed_seconds)
        echo -e "\r${indentation}|-- Progress: ${COLOR_CYAN}${percentage}%${COLOR_RESET} | Time: ${formatted_elapsed_time} | Files: ${index}/${entry_count}" >/dev/tty
    else
        # æ„å»ºè¿›åº¦æ¡
        filled=$((bar_length * index / entry_count))
        filled=$((filled > bar_length ? bar_length : filled))
        bar_content=$(eval printf "%0.s${progress_bar_char}" "{1..$filled}")

        # åŠ¨æ€è¾“å‡ºæ ¼å¼
        printf "\r%s%s [%s%s%s] %6s%% %s%s%s\033[K" \
            "${indentation}" \
            "${spinner_frames[index % ${#spinner_frames[@]}]}" \
            "$COLOR_GREEN" \
            "$bar_content" \
            "$COLOR_RESET" \
            "$percentage" \
            "$COLOR_CYAN" \
            "$display_filename" \
            "$COLOR_RESET"
    fi

    echo "$index"
}

# æ³¨å†Œä¸­æ–­å¤„ç†å‡½æ•°
function interrupt_handler() {
    echo -e "${COLOR_RED}\n- âŒ Checkout interrupted!${COLOR_RESET}" >&2
    exit 1
}
trap interrupt_handler SIGINT

# è·å–æ–‡ä»¶å’Œæ–‡ä»¶å¤¹æ€»æ•°
total_entry_count=0
declare -A folder_count_map
echo -e "${COLOR_CYAN}- ğŸ“ˆ Getting entry count in repo '$PARAM_BASE_SVN_URL'${COLOR_RESET}"
if [ -n "$PARAM_FOLDER_LIST" ]; then
    # å¤„ç†æ–‡ä»¶å¤¹åˆ—è¡¨
    for folder in $PARAM_FOLDER_LIST; do
        echo -e "  ${COLOR_CYAN}- ğŸ“‚ Getting entry count in folder '$folder'${COLOR_RESET}"
        folder_count_map["$folder"]=$(get_entry_count_in_svn_url "$PARAM_BASE_SVN_URL/$folder")
        if [ $((folder_count_map["$folder"])) -eq 0 ]; then
            echo -e "  ${COLOR_RED}- âŒ Error: Unable to get entry count in folder '$folder'${COLOR_RESET}" >&2
            exit 1
        fi
        echo -e "  ${COLOR_GREEN}- âœ”ï¸ Found ${folder_count_map[$folder]} entries"
        total_entry_count=$((total_entry_count + folder_count_map[$folder]))
    done
else
    total_entry_count=$(get_entry_count_in_svn_url "$PARAM_BASE_SVN_URL")
fi
[ "$total_entry_count" -le 0 ] && {
    echo -e "${COLOR_RED}- âŒ Error: Unable to get file count${COLOR_RESET}"
    exit 1
}
echo -e "${COLOR_GREEN}- âœ”ï¸ Found total $total_entry_count entries${COLOR_RESET}"

# å¼€å§‹æ£€å‡º
checkouted_count=0
echo -e "${COLOR_CYAN}- â³ Checking out repo '$PARAM_BASE_SVN_URL'${COLOR_RESET}"
svn_with_auth co --depth empty "$PARAM_BASE_SVN_URL" "$PARAM_LOCAL_DIR" >/dev/null 2>&1

if [ -n "$PARAM_FOLDER_LIST" ]; then
    # å¤„ç†æ–‡ä»¶å¤¹åˆ—è¡¨
    for folder in $PARAM_FOLDER_LIST; do
        echo -e "  ${COLOR_CYAN}- ğŸ“‚ Checking out folder '$folder'${COLOR_RESET}"
        checkouted_count=$((checkouted_count + $(update_with_progress "$PARAM_LOCAL_DIR/$folder" "${folder_count_map[$folder]}")))
    done
else
    checkouted_count=$((checkouted_count + $(update_with_progress "$PARAM_LOCAL_DIR" "$total_entry_count")))
fi

if [ "$checkouted_count" -ne "$total_entry_count" ]; then
    echo -e "${COLOR_RED}- Warning: Actual files checked out ($checkouted_count) differ from initial count ($total_entry_count)${COLOR_RESET}" >&2
fi

echo -e "\n${COLOR_GREEN}- âœ”ï¸ Checkout completed!${COLOR_RESET}"
