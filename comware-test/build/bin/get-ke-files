#!/bin/bash

# Get configuration from environment variables, use defaults as fallback
KE_SVN_URL=${KE_SVN_URL:-"http://10.153.3.214/comware-test-script/50.多环境移植/1/AIGC/KE_ver2/"}        # This should be set automatically
PROJECT_BASE_DIR=${PROJECT_BASE_DIR:-"/home/$USER/project"} # This should be set automatically

# shellcheck source=/dev/null
source "log-utils"
# shellcheck source=/dev/null
source "svn-utils"

# Use a hardcoded SVN credentials
# TODO: Find a better way to replace this stupid method
SVN_PASSWORD="Zpr758258%"
SVN_USERNAME="z11187"

get_svn_folder_contents() {
    local url=$1

    contents=$(svn_with_auth ls "${url}" 2>/dev/null | tr '\n' ',' | sed 's/,$//')
    result=$?
    if [ $result -ne 0 ]; then
        return $result
    fi
    echo "${contents}"
}

# export_by_tag_list() {
#     local url="$1"
#     local dest_dir="$2"
#     local tag_list="$3"
#     local separator="$4"

#     # Split by separator and export each tag individually
#     IFS="$separator" read -ra tags <<< "$tag_list"
#     for item in "${tags[@]}"; do
#         [ -z "$item" ] && continue
#         item_clean=$(echo "$item" | xargs)
#         svn_s export --force "${url}/${item_clean}/" "${dest_dir}/${item_clean}"
#     done
# }

export_by_url() {
    local url="$1"
    local dest_dir="$2"

    if [ -z "$(get_svn_folder_contents "${url}")" ]; then
        log_warn "No items under SVN URL: '${url}', skipping export."
        return
    fi
    svn_s export --force "${url}/" "${dest_dir}/"
}

select_script_examples() {
    local base_dir="$1"
    local tag_list="$2"

    local separator=","

    # Create an associative array for quick lookup
    declare -A valid_tags
    IFS="$separator" read -ra tags_array <<< "$tag_list"
    for tag in "${tags_array[@]}"; do
        tag_clean=$(echo "$tag" | xargs)
        valid_tags["$tag_clean"]=1
    done

    # Iterate over directories in the base_dir
    for dir in "${base_dir}/脚本示例/"*/; do
        [ -d "$dir" ] || continue
        dir_name=$(basename "$dir")
        if [ -z "${valid_tags[$dir_name]}" ]; then
            log_info "Removing redundant script example directory: ${dir}"
            rm -rf "$dir"
        else
            log_info "Keeping script example directory: ${dir}"
            folder_basename=$(basename "$dir")
            for python_file in "${dir}"*.py; do
                [ -f "$python_file" ] || continue
                mv -n "$python_file" "${dir}/${folder_basename}.py"
            done
        fi
    done
}

process() {
    local component="$1"
    local module="$2"
    local tag_list="$3"

    local temp_dir="/tmp/ke_export"
    local target_dir="${PROJECT_BASE_DIR}/KE知识库"

    if [ -z "${component}" ]; then
        log_info "Copying all items to '${temp_dir}'..."
        local components_list=$(get_svn_folder_contents "${KE_SVN_URL}")
        IFS=',' read -ra components <<< "$components_list"
        for component in "${components[@]}"; do
            [ -z "$component" ] && continue
            component=$(echo "$component" | xargs)
            export_by_url "${KE_SVN_URL}/${component}" "${temp_dir}/${component}"
        done
    elif [ -z "${module}" ]; then
        log_info "Copying all items under '${component}' to '${temp_dir}'..."
        export_by_url "${KE_SVN_URL}/${component}" "${temp_dir}/${component}"
    elif [ -z "${tag_list}" ]; then
        log_info "Copying all items under '${component}/${module}' to '${temp_dir}'..."
        export_by_url "${KE_SVN_URL}/${component}/${module}" "${temp_dir}/${component}/${module}"
    else
        log_info "Copying specified tags under '${component}/${module}' to '${temp_dir}'..."
        export_by_url "${KE_SVN_URL}/${component}/${module}" "${temp_dir}/${component}/${module}"
        select_script_examples "${temp_dir}/${component}/${module}" "${tag_list}"
    fi

    mkdir -p "${target_dir}/"
    if [ -d "${temp_dir}" ] && [ "$(ls -A "${temp_dir}" 2>/dev/null)" ]; then
        cp -r "${temp_dir}/"* "${target_dir}/"
    fi

    rm -rf "${temp_dir}"
}

# Main function
main() {
    local business_component=""
    local business_module=""
    local business_tag_list=""

    while [ $# -gt 0 ]; do
        case $1 in
            --component)
                business_component="$2"
                shift 2
                ;;
            --module)
                business_module="$2"
                shift 2
                ;;
            --tags)
                business_tag_list="$2"
                shift 2
                ;;
            *)
                log_error "Unknown argument: $1"
                exit 1
                ;;
        esac
    done

    process "$business_component" "$business_module" "$business_tag_list"
}

# Execute main function
main "$@"