#!/bin/bash

# Get configuration from environment variables, use defaults as fallback
PRESS_SVN_URL=${INFO_SVN_URL:-"http://10.153.3.214/comware-test-script/50.多环境移植/1/AIGC/INFO/"}  # This should be set automatically
PROJECT_BASE_DIR=${PROJECT_BASE_DIR:-"/home/$USER/project"} # This should be set automatically

# shellcheck source=/dev/null
source "log-utils"
# shellcheck source=/dev/null
source "svn-utils"

# Use a hardcoded SVN credentials
# TODO: Find a better way to replace this stupid method
SVN_PASSWORD="Zpr758258%"
SVN_USERNAME="z11187"

get_svn_folder_contents() {
    local url=$1

    contents=$(svn_with_auth ls "${url}" 2>/dev/null | tr '\n' ',' | sed 's/,$//')
    result=$?
    if [ $result -ne 0 ]; then
        return $result
    fi
    echo "${contents}"
}

export_by_url() {
    local url="$1"
    local dest_dir="$2"

    if [ -z "$(get_svn_folder_contents "${url}")" ]; then
        log_warn "No items under SVN URL: '${url}', skipping export."
        return
    fi
    svn_s export --force "${url}/" "${dest_dir}/"
}

export_dynamically() {
    local url="$1"
    local dest_dir="$2"
    local categories="$3"
    local details="$4"

    if [ -z "${url}" ]; then
        log_error "URL is required."
        exit 1
    fi

    if [ -z "${dest_dir}" ]; then
        log_error "Destination directory is required."
        exit 1
    fi

    if [ -z "${categories}" ]; then
        log_info "Copying all items to '${dest_dir}'..."
        local components_list=$(get_svn_folder_contents "${url}")
        IFS=',' read -ra components <<< "$components_list"
        for component in "${components[@]}"; do
            [ -z "$component" ] && continue
            component=$(echo "$component" | xargs)
            export_by_url "${url}/${component}" "${dest_dir}/${component}"
        done
        return
    fi

    IFS=',' read -ra category_arr <<< "${categories}"
    IFS=';' read -ra detail_groups <<< "${details}"


    for idx in "${!category_arr[@]}"; do
        local category="${category_arr[$idx]}"
        category=$(echo "$category" | xargs)
        log_info "category: $category"
        [ -z "${category}" ] && continue

        local group=""
        if [ ${#detail_groups[@]} -gt ${idx} ]; then
            group="${detail_groups[$idx]}"
        fi
        log_info "group: $group"

        if [ -z "${group}" ]; then
            log_info "Copying all items under '${category}' to '${dest_dir}/${category}'..."
            export_by_url "${url}/${category}" "${dest_dir}/${category}"
            continue
        fi

        IFS=',' read -ra detail_arr <<< "${group}"
        for detail in "${detail_arr[@]}"; do
            detail=$(echo "$detail" | xargs)
            log_info "detail: $detail"
            [ -z "${detail}" ] && continue
            log_info "Copying '${category}/${detail}' to '${dest_dir}/${category}/${detail}'..."
            export_by_url "${url}/${category}/${detail}" "${dest_dir}/${category}/${detail}"
        done
    done
}

process_files(){
    local version="$1"
    local categories="$2"
    local details="$3"

    local temp_dir=""
    local target_dir=""

    temp_dir="/tmp/press"
    target_dir="${PROJECT_BASE_DIR}/press/"
    # The module name in script_expansions does not have detailed suffixes
    export_dynamically "${PRESS_SVN_URL}${version}" "${temp_dir}" "${categories}" "${details}"

    mkdir -p "${target_dir}/"
    if [ -d "${temp_dir}" ] && [ "$(ls -A "${temp_dir}" 2>/dev/null)" ]; then
        cp -r "${temp_dir}/"* "${target_dir}/"
    fi

    rm -rf "${temp_dir}"
}

# Main function
main() {
    local categories=""
    local details=""
    local version=""

    while [ $# -gt 0 ]; do
        case $1 in
            --categories)
                categories="$2"
                shift 2
                ;;
            --details)
                details="$2"
                shift 2
                ;;
            --version)
                version="$2"
                shift 2
                ;;
            *)
                log_error "Unknown argument: $1"
                exit 1
                ;;
        esac
    done

    echo "version: $version"
    echo "categories: $categories"
    echo "details: $details"

    process_files "$version" "$categories" "$details"
}

# Execute main function
main "$@"
