.. _topics-拓扑初始化:


拓扑初始化
===========


命令行自动化测试时，完成拓扑映射后，自动化框架会对所有设备进行初始化，不同类型的设备的初始化，其操作有所差异。拓扑初始化失败，使用该拓扑的脚本不会继续执行。

-------------------
Comware设备初始化
-------------------

Comware设备初始化涉及如下操作：

#. 打开设备控制台窗口，并检查设备是否可用
#. 关闭 t m，去使能设备分页功能
#. iTC执行时，进行配置回滚
#. 关闭 lldp stp，删除所有vlan，下发初始化配置（ 如果测试床中配置了初始化配置）
#. 根据conftest.py设置的 ``level`` 值，如果为3，则进行vlan、ip等的配置，并undo shut映射到的物理端口和vlan虚接口，如果为2，则只undo shut物理端口

另外，对于一些特殊设备的初始化（如simware9），额外增加登录linux宿主机以及 attach docker 的操作。


跳过初始化
------------

在一些特殊场景，不需要自动化框架对某些设备进行上述初始化的第3、4、5步，可以在测试床对应设备的初始配置中增加 ``skip initial`` 跳过初始化，如下图示：

跳过初始化示例：

.. image:: ./images/跳过初始化.jpg


Comware设备配置回滚
--------------------

iTC执行时，为了避免设备的已有配置影响脚本执行结果，会对设备进行回滚配置的操作。回滚时使用名称为 ``atfinitial.cfg`` 的配置文件，如果没有该文件，则会进行空配置重启并生成 ``atfinitial(xxxx).cfg`` 的配置文件。

``atfinitial.cfg`` 配置文件由环境责任人手工生成，规则为：空配置重启后，关闭所有端口（堆叠等特殊端口除外），关闭info-center。 

.. note:: ``atfinitial.cfg`` 不能作为设备的启动文件，否则脚本中的save动作会修改该配置文件


-------------------
测试仪器初始化
-------------------

测试仪的初始化相对简单：


TestMaster
--------------------

#. 连接机框（如果未指定用户名，则随机创建，可在输出窗口查看）
#. 端口占用
#. 清空配置（如果初始配置包含 ``skip initial`` ，则跳过该步骤）
#. 获取版本信息


其它测试仪
--------------------

#. 连接机框
#. 端口占用（L47层测试仪跳过该步骤，如IxiaBps）


-------------------
LoalHost初始化
-------------------

依据测试床的LocalHost的配置，对指定网卡进行ipv4和ipv6地址配置，如果网卡上地址与测试床地址一致，则不会重复配置


-------------------
PCServer初始化
-------------------

这类设备通常用于辅助测试，如GeneralServer，RadiusServer等，框架对其初始化无任何操作。

