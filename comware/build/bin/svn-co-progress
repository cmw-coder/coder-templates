#!/bin/bash
function format_duration() {
    local seconds=$1
    local hours=$(( seconds / 3600 ))
    local minutes=$(( (seconds % 3600) / 60 ))
    local seconds=$(( seconds % 60 ))
    printf "%02d:%02d:%02d" $hours $minutes $seconds
}

function get_base_path() {
    local url="$1"
    local base_path
    base_path=$(echo "$url" | sed -E '
        s#^[^/]+://[^/]+##;    # ç§»é™¤åè®®å’ŒåŸŸå
        s#/$##;                # ç§»é™¤ç»“å°¾æ–œæ 
        s#^/?##                # ç§»é™¤å¯èƒ½æ®‹ç•™çš„èµ·å§‹æ–œæ 
    ')
    echo "$base_path" | sed 's/[\/&]/\\&/g'
}

function get_filename_max_length() {
    local term_length=$1
    local bar_length=$2
    local filename_max_length=$(( term_length - (bar_length + 16) ))  # ä¿ç•™16å­—ç¬¦ç»™å…¶ä»–å…ƒç´ 
    filename_max_length=$(( filename_max_length > 10 ? filename_max_length : 10 ))  # æœ€å°æ˜¾ç¤º10å­—ç¬¦
    filename_max_length=$(( filename_max_length - 3 ))  # ç•™3å­—ç¬¦ç»™çœç•¥å·
    echo $filename_max_length
}

function get_local_dir() {
    local path="$1"
    local local_dir
    local_dir=$(basename "$path")
    echo "$local_dir" | sed 's/[\/&]/\\&/g'
}

function get_progress_bar_character() {
    if echo "â–ˆ" | grep -q "â–ˆ"; then
        echo "â–ˆ"
    else
        echo "#"
    fi
}

function get_progress_bar_length() {
    local bar_length=$(( $1 - 50 ))
    bar_length=$(( bar_length > 20 ? bar_length : 20 ))  # æœ€å°20å­—ç¬¦
    bar_length=$(( bar_length < 60 ? bar_length : 60 ))  # æœ€å¤§60å­—ç¬¦
    echo $bar_length
}

function interrupt_handler() {
    echo -e "${COLOR_RED}\n- âŒ Checkout interrupted!${COLOR_RESET}" >&2
    exit 1
}

# æ³¨å†Œä¸­æ–­å¤„ç†å‡½æ•°
trap interrupt_handler SIGINT

# å‚æ•°æ£€æŸ¥
if [ $# -ne 4 ]; then
    echo "- â” Usage: svn-co-process <url> <folder-list> <path> <username> <password>"
    exit 1
fi

# å¸¸é‡
ESCAPED_BASE_PATH=$(get_base_path "$1")
ESCAPED_LOCAL_DIR=$(get_local_dir "$2")
PROGRESS_CHAR=$(get_progress_bar_character)
SPINNER_FRAMES=("â ‹" "â ™" "â ¹" "â ¸" "â ¼" "â ´" "â ¦" "â §" "â ‡" "â ")
TERM_LENGTH=$(tput cols 2>/dev/null || echo 80)

# è®¡ç®—é‡
BAR_LENGTH=$(get_progress_bar_length "$TERM_LENGTH")
FILENAME_MAX_LENGTH=$(get_filename_max_length "$TERM_LENGTH" "$BAR_LENGTH")
FILENAME_TRUNCATED_FRONT_LENGTH=$(( FILENAME_MAX_LENGTH / 2 ))
FILENAME_TRUNCATED_BACK_LENGTH=$(( FILENAME_MAX_LENGTH - FILENAME_TRUNCATED_FRONT_LENGTH ))

# é¢œè‰²æ”¯æŒæ£€æµ‹
if [ -n "$CODER" ] || [ -t 1 ]; then
    COLOR_GREEN=$(echo -e "\033[32m")
    COLOR_CYAN=$(echo -e "\033[36m")
    COLOR_RED=$(echo -e "\033[31m")
    COLOR_RESET=$(echo -e "\033[0m")
else
    COLOR_GREEN="" && COLOR_CYAN="" && COLOR_RED="" && COLOR_RESET=""
fi

# è·å–æ–‡ä»¶æ€»æ•°
echo -e "${COLOR_CYAN}- ğŸ“ˆ Getting file count in repo '$1'${COLOR_RESET}"
for retry in {1..3}; do
    TOTAL_FILE_COUNT=$(svn list -R "$1" --non-interactive --username "$3" --password "$4" 2>/dev/null | awk '!/\/$/ {count++} END {print count}')
    [ "$TOTAL_FILE_COUNT" -gt 0 ] && break
    echo -e "${COLOR_RED}- â— Retry $retry/3 getting file count...${COLOR_RESET}" >&2
    sleep 1
done
[ "$TOTAL_FILE_COUNT" -eq 0 ] && { echo -e "${COLOR_RED}- âŒ Error: Unable to get file count${COLOR_RESET}"; exit 1; }

# è¾“å‡ºè¿›åº¦
START_TIME=$(date +%s)
UPDATE_INTERVAL=$(( TOTAL_FILE_COUNT / 800 ))
UPDATE_INTERVAL=$(( UPDATE_INTERVAL > 5 ? UPDATE_INTERVAL : 5 ))

# å¼€å§‹æ£€å‡º
index=0
last_update_time=0
echo -e "${COLOR_GREEN}- â³ Checking out repo '$1' (Total files: $TOTAL_FILE_COUNT)${COLOR_RESET}"
while read -r line; do
    # è§£æåŸå§‹æ–‡ä»¶å
    raw_filename=$(echo "$line" | sed -E 's/^[A-Z] +//')

    # å¤šçº§è·¯å¾„æˆªæ–­å¤„ç†
    display_filename=$(echo "$raw_filename" | sed -E "
        s#^${ESCAPED_LOCAL_DIR}/?##;
        s#^${ESCAPED_BASE_PATH}/?##;
        s#^/?##;
        s/^(.{$FILENAME_TRUNCATED_FRONT_LENGTH}).*(.{$FILENAME_TRUNCATED_BACK_LENGTH})$/\1...\2/;
        t;
        s/^(.{${FILENAME_MAX_LENGTH}}).+/\1.../;
    ")

    # è¿›åº¦è®¡ç®—
    ((index++))
    percentage=$(awk "BEGIN {printf \"%.2f\", $index*100/$TOTAL_FILE_COUNT}")
    filled=$(( BAR_LENGTH * index / TOTAL_FILE_COUNT ))
    filled=$(( filled > BAR_LENGTH ? BAR_LENGTH : filled ))

    # Coderç¯å¢ƒä¸‹æŒ‰æ—¶é—´é—´éš”è¾“å‡º
    if [ -n "$CODER" ]; then
        current_time=$(date +%s)
        if (( current_time - last_update_time >= UPDATE_INTERVAL )); then
            elapsed_seconds=$(( current_time - START_TIME ))
            formatted_elapsed_time=$(format_duration $elapsed_seconds)
            echo -e "\r|-- Progress: ${COLOR_CYAN}${percentage}%${COLOR_RESET} | Time: ${formatted_elapsed_time} | Files: ${index}/${TOTAL_FILE_COUNT}"
            last_update_time=$current_time
        fi
    else
        # æ„å»ºè¿›åº¦æ¡
        bar_content=$(eval printf "%0.s${PROGRESS_CHAR}" "{1..$filled}")
        # åŠ¨æ€è¾“å‡ºæ ¼å¼
        if [ -n "$CODER" ]; then
            echo ""
        fi
        printf "\r%s [%s%s%s] %6s%% %s%s%s\033[K" \
            "${SPINNER_FRAMES[index % ${#SPINNER_FRAMES[@]}]}" \
            "$COLOR_GREEN" \
            "$bar_content" \
            "$COLOR_RESET" \
            "$percentage" \
            "$COLOR_CYAN" \
            "$display_filename" \
            "$COLOR_RESET"
    fi
done < <(svn co "$1" "$2" --non-interactive --username "$3" --password "$4" 2>&1)

if [ "$index" -ne "$TOTAL_FILE_COUNT" ]; then
    echo -e "${COLOR_RED}- Warning: Actual files checked out ($index) differ from initial count ($TOTAL_FILE_COUNT)${COLOR_RESET}" >&2
fi

echo -e "\n${COLOR_GREEN}- âœ”ï¸ Checkout completed!${COLOR_RESET}"
