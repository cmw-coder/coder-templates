.. _topics-拓扑映射:


拓扑映射机制
================
拓扑映射是用于支持脚本可以跨组网执行，而设计的一套自动完成逻辑设备到物理设备的映射机制。该机制将自动化测试文件分为三类：测试床文件、拓扑文件和脚本文件。

----------
文件分类
----------

1. 测试床文件描述了真实物理组网的信息，其后缀为.tbdx（或.tbd），包括：

- 设备信息：设备名称、设备类型、连接地址、连接协议、用户名/密码、docker名称等
- 连接信息：连接使用的两个（或多个）设备端口，以及端口所属vlan、端口配置的ipv4/ipv6地址信息


2. 拓扑文件描述了脚本执行所需要的最小逻辑组网的信息，其后缀为.topox（或topo），包括：

- 设备信息：逻辑设备名称、设备类型
- 连接信息：连接使用的两个（或多个）逻辑设备名称及逻辑端口名称
- 映射限制：如要求逻辑设备DUT为双主控设备

3. 脚本是将测试点（用例）的操作过程、检查方法等通过编程语言实现后的文件，是测试点（用例）的自动化体现。脚本中通过逻辑设备名称操作实际测试设备。


-------------
机制介绍
-------------
拓扑映射是在测试床中查找符合拓扑要求（设备类型、连接数量、映射限制）的组网，自动化框架用逻辑设备名称创建对象，并与实际设备绑定，实现通过对象的方法操作实际设备，如调用对象方法send向设备下发命令xxx，代码为 ``DUT.send('xxx')``

由于脚本使用的都是逻辑对象名称，不涉及任何实际组网信息，从而实现脚本可以跨组网执行。

测试床、拓扑、脚本的关系图：

.. image::  images/mapping.png


----------------
测试床、拓扑介绍
----------------

测试床文件、拓扑文件的描述规则较为复杂，建议使用VTP-Cloud平台的组网编辑功能完成创建。


创建测试床
-------------

1、创建测试床文件示例：

.. image:: ./images/新建测试床.jpg


2、编辑测试床设备信息示例：

.. image:: ./images/测试床设备信息.jpg


.. note:: 设备访问方式为Serial协议时，访问地址格式为COMX:波特率，例如 COM1:12500，如不指定波率，默认9600


3、编辑测试床连接信息示例：

.. image:: ./images/测试床连接信息.jpg

连接信息中以太网端口的 **端口类型** 包含5种模式：

- L2：bridge模式，不能切换为route
- L3：route模式，不能切换为bridge
- LB：默认为bridge模式，支持切换为route
- LR：默认为route模式，支持切换为bridge
- 不带后缀：不区分bridge/route



创建拓扑
-------------

1、创建拓扑文件与创建测试床文件类似，从模板文件中新建时选择 **拓扑(.topox)** 类型的文件


2、编辑拓扑设备信息示例：

.. image:: ./images/拓扑设备信息.jpg


3、编辑拓扑连接信息示例：

.. image:: ./images/拓扑连接信息.jpg


-------------
拓扑映射约束
-------------

拓扑映射机制提供了多种映射约束，应对复杂的测试场景，下面介绍经常用到的强制映射约束。

1、设备强制映射约束支持如下，在拓扑的设备信息中设置：

- 设备类型
- 设备单主控
- 设备双主控
- 主测设备类型相同

2、链路强制映射约束支持如下，在拓扑的连接信息中设置：

- 端口类型
- 端口所在的板卡类型
- 端口是否在同一板卡上
- 链路是否为直连

其中端口类型映射规则如下：

- 如果映射约束为 Ethernet，所有速率的以太端口类型均能映射上，其它速率则为一对一映射，比如 GigabitEthernet 只能映射到 GigabitEthernet
- 如果映射约束包含(L2)，L2 LB LR都能映射上，初始化时，LR会自动切换为bridge模式
- 如果映射约束包含(L3)，L3 LB LR都能映射上，初始化时，LB会自动切换为route模式


-------------
补充说明
-------------
拓扑映射机制的产生源于要求脚本在不同组网上执行，如果在脚本只在固定组网执行，可以不必遵守拓扑映射机制的约束。框架提供了一种固定组网执行模式，不需要创建拓扑文件，只要简明扼要的描述下当前组网信息即可。