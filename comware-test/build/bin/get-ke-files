#!/bin/bash

# Get configuration from environment variables, use defaults as fallback
KE_SVN_URL=${KE_SVN_URL:-"http://10.153.3.214/comware-test-script/50.多环境移植/1/AIGC/KE/"}    # This should be set automatically
PROJECT_BASE_DIR=${PROJECT_BASE_DIR:-"/home/$USER/project"} # This should be set automatically

# shellcheck source=/dev/null
source "log-utils"
# shellcheck source=/dev/null
source "svn-utils"

# Use a hardcoded SVN credentials
# TODO: Find a better way to replace this stupid method
SVN_PASSWORD="Zpr758258%"
SVN_USERNAME="z11187"

get_svn_folder_contents() {
    local url=$1

    contents=$(svn_with_auth ls "${url}" 2>/dev/null | tr '\n' ',' | sed 's/,$//')
    result=$?
    if [ $result -ne 0 ]; then
        return $result
    fi
    echo "${contents}"
}

export_by_tag_list() {
    local url="$1"
    local dest_dir="$2"
    local tag_list="$3"
    local separator="$4"

    # Split by separator and export each tag individually
    IFS="$separator" read -ra tags <<< "$tag_list"
    for item in "${tags[@]}"; do
        [ -z "$item" ] && continue
        item_clean=$(echo "$item" | xargs)
        svn_s export --force "${url}/${item_clean}/" "${dest_dir}/${item_clean}"
    done
}

export_by_url() {
    local url="$1"
    local dest_dir="$2"

    if [ -z "$(get_svn_folder_contents "${url}")" ]; then
        log_warn "No items under SVN URL: '${url}', skipping export."
        return
    fi
    svn_s export --force "${url}/" "${dest_dir}/"
}

export_dynamically() {
    local url="$1"
    local dest_dir="$2"
    local component="$3"
    local module="$4"
    local tag_list="$5"

    if [ -z "${url}" ]; then
        log_error "URL is required."
        exit 1
    fi

    if [ -z "${dest_dir}" ]; then
        log_error "Destination directory is required."
        exit 1
    fi

    if [ -z "${component}" ]; then
        log_info "Copying all items to '${dest_dir}'..."
        local components_list=$(get_svn_folder_contents "${url}")
        IFS=',' read -ra components <<< "$components_list"
        for component in "${components[@]}"; do
            [ -z "$component" ] && continue
            component=$(echo "$component" | xargs)
            export_by_url "${url}/${component}" "${dest_dir}"
        done
    elif [ -z "${module}" ]; then
        log_info "Copying all items under '${component}' to '${dest_dir}'..."
        export_by_url "${url}/${component}" "${dest_dir}"
    elif [ -z "${tag_list}" ]; then
        log_info "Copying all items under '${component}/${module}' to '${dest_dir}'..."
        export_by_url "${url}/${component}/${module}" "${dest_dir}"
    else
        log_info "Copying specified tags under '${component}/${module}' to '${dest_dir}'..."
        export_by_tag_list "${url}/${component}/${module}" "${dest_dir}" "${tag_list}" ","
    fi
}

process_by_category(){
    local category="$1"
    local component="$2"
    local module="$3"
    local tag_list="$4"

    local folder_name=""
    local temp_dir=""
    local target_dir=""
    case "$category" in
        # basic_config)
        #     folder_name="基础配置KE"
        #     temp_dir="/tmp/basic_config"
        #     target_dir="${PROJECT_BASE_DIR}/KE"
        #     export_dynamically "${KE_SVN_URL}${folder_name}" "${temp_dir}" "$component" "$module" "$tag_list"
        #     ;;
        # test_design)
        #     folder_name="测试设计KE"
        #     temp_dir="/tmp/test_design"
        #     target_dir="${PROJECT_BASE_DIR}/KE"
        #     export_dynamically "${KE_SVN_URL}${folder_name}" "${temp_dir}" "$component" "$module" "$tag_list"
        #     ;;
        background_scripts)
            folder_name="背景脚本KE"
            temp_dir="/tmp/background_scripts"
            target_dir="${PROJECT_BASE_DIR}/KE/${component}/${module}"
            export_dynamically "${KE_SVN_URL}${folder_name}" "${temp_dir}" "${component}" "${module}"

            # Get all folders under the /tmp/background_scripts, 
            # rename "conftest.py" in these folders to "conftest_{folder_name}.py", 
            # and "*.topox" files to "{folder_name}.topox".
            for dir in "${temp_dir}/"*/; do
                [ -d "$dir" ] || continue
                folder_basename=$(basename "$dir")
                if [ -f "${dir}/conftest.py" ]; then
                    mv "${dir}/conftest.py" "${dir}/conftest_${folder_basename}.py"
                fi
                for topox_file in "${dir}"*.topox; do
                    [ -f "$topox_file" ] || continue
                    mv -n "$topox_file" "${dir}/${folder_basename}.topox"
                done
            done
            ;;
        script_expansions)
            folder_name="脚本扩写KE"
            temp_dir="/tmp/script_expansions"
            target_dir="${PROJECT_BASE_DIR}/KE/${component}/${module}"
            # The module name in script_expansions does not have detailed suffixes
            export_dynamically "${KE_SVN_URL}${folder_name}" "${temp_dir}" "${component}" "${module%_*}"
            ;;
        script_examples)
            folder_name="脚本样例KE"
            temp_dir="/tmp/script_examples"
            target_dir="${PROJECT_BASE_DIR}/test_example/${component}/${module}"
            export_dynamically "${KE_SVN_URL}${folder_name}" "${temp_dir}" "${component}" "${module}" "${tag_list}"
            ;;
        *)
            log_error "Unsupported category: $category"
            exit 1
            ;;
    esac

    mkdir -p "${target_dir}/"
    if [ -d "${temp_dir}" ] && [ "$(ls -A "${temp_dir}" 2>/dev/null)" ]; then
        cp -r "${temp_dir}/"* "${target_dir}/"
    fi

    rm -rf "${temp_dir}"
}

# Main function
main() {
    local business_component=""
    local business_module=""
    local business_tag_list=""

    while [ $# -gt 0 ]; do
        case $1 in
            --component)
                business_component="$2"
                shift 2
                ;;
            --module)
                business_module="$2"
                shift 2
                ;;
            --tags)
                business_tag_list="$2"
                shift 2
                ;;
            *)
                log_error "Unknown argument: $1"
                exit 1
                ;;
        esac
    done

    # process_by_category "basic_config" "$business_component" "$business_module" "$business_tag_list"
    # process_by_category "test_design" "$business_component" "$business_module" "$business_tag_list"
    process_by_category "background_scripts" "$business_component" "$business_module" "$business_tag_list"
    process_by_category "script_expansions" "$business_component" "$business_module" "$business_tag_list"
    process_by_category "script_examples" "$business_component" "$business_module" "$business_tag_list"
}

# Execute main function
main "$@"